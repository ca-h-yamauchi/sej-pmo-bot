# Slack アカウント申請自動化システム 利用マニュアル

## 目次

1. [クイックスタート](#クイックスタート)
2. [設定確認チェックリスト](#設定確認チェックリスト)
3. [概要](#概要)
4. [セットアップ手順](#セットアップ手順)
5. [ローカルテスト](#ローカルテスト)
6. [使用方法](#使用方法)
7. [トラブルシューティング](#トラブルシューティング)
8. [よくある質問](#よくある質問)

## クイックスタート

### 5分で確認！設定が正しくできているかチェック

1. **Cloud FunctionsのURLを確認**
   - GCP Console → Cloud Run → サービス名を選択
   - URLが表示されているか確認（例: `https://slack-bot-handler-xxx.asia-northeast1.run.app`）

2. **Slack AppのEvent Subscriptionsを確認**
   - [Slack API](https://api.slack.com/apps) → アプリを選択 → 「Event Subscriptions」
   - 「イベントを有効にする」がオンになっているか
   - Request URLにCloud FunctionsのURLが設定されているか
   - ✅ マークが表示されていればOK（エラーが出ていれば[トラブルシューティング](#event-subscriptionsのurl検証エラー)を参照）

3. **実際にテスト**
   - Slackチャンネルでボットにメンションを送る
   - 例: `@Bot 佐藤太郎さんのアカウント作成をお願い。SREチーム、sato@example.com`
   - ボットから返信が来れば成功！
   - 複数の依頼を1回のメッセージで送ることも可能（例: `@Bot 佐藤太郎さんと田中花子さんのアカウント作成をお願いします`）

4. **エラーが出た場合のログ確認**
   - GCP Console → Cloud Run → サービス名を選択 → 「オブザーバビリティ」タブ
   - または、[Cloud Logging](https://console.cloud.google.com/logs) で確認
   - 詳細は[ログ確認方法](#cloud-functionsのログ確認)を参照

### 動作確認の流れ

```
Slackでメンション送信
    ↓
Cloud Functionsが受信（Cloud Loggingで確認可能）
    ↓
Vertex AIで情報抽出
    ↓
Googleスプレッドシートに書き込み
    ↓
Slackに返信
```

## 設定確認チェックリスト

### ✅ GCP設定

- [ ] GCPプロジェクトが作成されている
- [ ] Vertex AI APIが有効化されている
- [ ] **Google Sheets APIが有効化されている** ⚠️ **必須**
- [ ] Cloud Functions APIが有効化されている
- [ ] Cloud Run APIが有効化されている
- [ ] Cloud Functions（第2世代）がデプロイされている
- [ ] エントリーポイントが `slack_bot_handler` に設定されている
- [ ] 環境変数が正しく設定されている:
  - [ ] `SLACK_BOT_TOKEN`
  - [ ] `SLACK_SIGNING_SECRET`
  - [ ] `SPREADSHEET_KEY`
  - [ ] `PROJECT_ID`
  - [ ] `LOCATION`

### ✅ Googleスプレッドシート設定

- [ ] スプレッドシートが作成されている
- [ ] 1行目にヘッダーが設定されている（問合せNo、タイムスタンプ、問合せ者、問合せ元Slack URL、大分類、中分類、小分類、【対象】氏名、【対象】Email、【対象】所属チーム、対応期日、概要・詳細、元のメッセージ）
- [ ] Cloud Functionsのサービスアカウントに「編集者」権限が付与されている

### ✅ Slack App設定

- [ ] Slack Appが作成されている
- [ ] Bot Token Scopesが設定されている:
  - [ ] `app_mentions:read`
  - [ ] `chat:write`
- [ ] Event Subscriptionsが有効化されている
- [ ] Request URLがCloud FunctionsのURLに設定されている
- [ ] ✅ マークが表示されている（エラーが出ていない）
- [ ] Bot Eventsで `app_mentions` が購読されている
- [ ] Bot User OAuth Token (`xoxb-...`) を取得済み
- [ ] Signing Secretを取得済み
- [ ] ボットがSlackチャンネルに追加されている

### ✅ 動作テスト

- [ ] Slackチャンネルでボットにメンションを送信できる
- [ ] ボットから返信が来る
- [ ] Googleスプレッドシートにデータが書き込まれている

### 📋 設定確認の具体的な手順

#### 1. Cloud Functionsの動作確認

**URLの確認:**
1. [GCP Console](https://console.cloud.google.com/) → 「Cloud Run」を開く
2. サービス名（例: `slack-bot-handler`）をクリック
3. 「概要」タブでURLを確認（例: `https://slack-bot-handler-xxx.asia-northeast1.run.app`）

**環境変数の確認:**
1. 「変数とシークレット」タブを開く
2. 以下の環境変数が設定されているか確認:
   - `SLACK_BOT_TOKEN` = `xoxb-...`
   - `SLACK_SIGNING_SECRET` = `...`
   - `SPREADSHEET_KEY` = `...`
   - `PROJECT_ID` = `...`
   - `LOCATION` = `us-central1`（推奨）
     - ⚠️ **注意**: `asia-northeast1` では Gemini 2.5 Flash Lite が正常に動作しない場合があります

**エントリーポイントの確認:**
1. 「ソース」タブを開く
2. 「関数のエントリーポイント」が `slack_bot_handler` になっているか確認
3. 警告が出ていないか確認

#### 2. Slack Appの設定確認

**Event Subscriptionsの確認:**
1. [Slack API](https://api.slack.com/apps) → アプリを選択
2. 「Event Subscriptions」を開く
3. 「イベントを有効にする」がオンになっているか確認
4. Request URLにCloud FunctionsのURLが設定されているか確認
5. ✅ マークが表示されているか確認（エラーが出ている場合は[トラブルシューティング](#event-subscriptionsのurl検証エラー)を参照）

**Bot Eventsの確認:**
1. 「ボットイベントを購読する」を展開
2. `app_mentions` が追加されているか確認

#### 3. 実際にテストする

**テスト手順:**
1. Slackチャンネルを開く（ボットが追加されているチャンネル）
2. ボットにメンションを送る:
   ```
   @Bot 佐藤太郎さんのアカウント作成をお願い。SREチーム、sato@example.com
   ```
   または複数の依頼を1回で送る場合:
   ```
   @Bot 佐藤太郎さんと田中花子さんのアカウント作成をお願いします。sato@example.com、tanaka@example.com
   ```
3. 数秒待つ
4. ボットから返信が来るか確認:
   - ✅ 成功: 「お問合せ頂いた内容について、以下の通りスプレッドシートに{件数}件登録しました。認識相違が無いかご確認ください。」という返信と各件の詳細
   - ❌ 失敗: エラーメッセージまたは返信なし

**スプレッドシートの確認:**
1. Googleスプレッドシートを開く
2. 新しい行が追加されているか確認（複数の依頼の場合は複数行追加される）
3. タイムスタンプ、問合せ者、大分類、対象者情報、所属チームが正しく記録されているか確認

**エラーが出た場合:**
- Cloud Loggingでエラーログを確認
- [トラブルシューティング](#トラブルシューティング)を参照

## 概要

本システムは、Slackのメンション機能を使用して、アカウント申請情報を自動的にGoogleスプレッドシートに記録するボットです。Vertex AI (Gemini) を使用して、自然言語から必要な情報を自動抽出します。

### 主な機能

- Slackメンションによる情報入力
- 問合せ者の自動特定（Slack送信者名を記録）
- AIによる自動情報抽出（対象者情報、分類、所属チームの正規化）
- 複数依頼の対応（1回のメッセージで複数の依頼を処理）
- Googleスプレッドシートへの自動記録（1件ずつ行を分けて登録）
- 処理結果のSlack通知

## セットアップ手順

### 1. 前提条件

- Google Cloud Platform (GCP) アカウント
- Slack Workspace管理者権限
- Googleスプレッドシートの作成権限

### 2. GCPプロジェクトの準備

#### 2.1. プロジェクト作成

1. [GCP Console](https://console.cloud.google.com/) にログイン
2. 新しいプロジェクトを作成
3. プロジェクトIDをメモ

#### 2.2. 必要なAPIの有効化

以下のAPIを有効化する必要があります:

**Vertex AI API:**
1. GCP Consoleで「APIとサービス」→「ライブラリ」を開く
2. "Vertex AI API" を検索して有効化

**Google Sheets API（重要）:**
1. GCP Consoleで「APIとサービス」→「ライブラリ」を開く
2. "Google Sheets API" を検索して有効化
3. ⚠️ **必須**: スプレッドシートへの書き込みにはこのAPIが必要です

#### 2.3. Cloud Functionsの準備

1. **APIの有効化**
   - GCP Consoleで「APIとサービス」→「ライブラリ」を開く
   - "Cloud Functions API" を検索して有効化
   - "Cloud Run API" を検索して有効化（第2世代はCloud Run上で動作）

2. **Cloud Functions (第2世代) の作成**

   GCP Consoleから作成する場合の詳細設定:

   **基本設定:**
   - **デプロイソース**: 「Functions」を選択（インラインエディタで関数を作成）
   - **サービスの名前**: `slack-bot-handler` など任意の名前
   - **リージョン**: `us-central1` を推奨
     - ⚠️ **注意**: `asia-northeast1` では Gemini 2.5 Flash Lite が正常に動作しない場合があります
     - ✅ **推奨**: `us-central1` を使用してください
   - **ランタイム**: `Python 3.11`
   - **エントリーポイント**: `slack_bot_handler`

   **課金設定:**
   - **課金**: 「リクエストベース」を選択
     - リクエスト処理時のみ課金され、コスト効率が良い

   **スケーリング設定:**
   - **サービスのスケーリング**: 「自動スケーリング」を選択
   - **インスタンスの最小数**: `0`（コスト削減のため）
   - **インスタンスの最大数**: 空欄（デフォルトの制限値を使用）
   - **起動時のCPUブースト**: ✅ チェック（コールドスタートを高速化）

   **Ingress設定:**
   - **Ingress**: 「すべて」を選択
     - インターネットからサービスに直接アクセス可能

   **コンテナ設定:**
   - **コンテナポート**: `8080`（Cloud Functionsのデフォルト）
   - **メモリ**: `512 MiB`（デフォルト、必要に応じて増やす）
   - **CPU**: `1`（デフォルト）

   **リクエスト設定:**
   - **リクエストのタイムアウト**: `300` 秒（5分）
   - **インスタンスあたりの最大同時リクエスト数**: `80`（デフォルト）

   **実行環境:**
   - **実行環境**: 「デフォルト」を選択
     - Cloud Runが適切な実行環境を自動選択

   **認証設定:**
   - **認証**: 「公開アクセスを許可する」を選択
     - Slackの署名検証で保護されるため、未認証で問題なし

   **環境変数の設定:**
   後述の「5.2. 環境変数の設定」を参照

   **注意事項:**
   - Cloud Functions (第2世代) は実際にはCloud Run上で動作します
   - 設定画面はCloud Runのものになりますが、機能は同じです

#### 2.4. サービスアカウントの設定

1. 「IAMと管理」→「サービスアカウント」を開く
2. Cloud Functions用のサービスアカウントを選択
3. 以下の権限を付与:
   - `roles/aiplatform.user` (Vertex AI使用)
   - スプレッドシートへの読み書き権限

### 3. Googleスプレッドシートの準備

#### 3.1. スプレッドシート作成

1. Googleスプレッドシートを新規作成
2. 1行目に以下のヘッダーを設定:
   ```
   A1: 問合せNo
   B1: タイムスタンプ
   C1: 問合せ者
   D1: 問合せ元Slack URL
   E1: 大分類
   F1: 中分類
   G1: 小分類
   H1: 【対象】氏名
   I1: 【対象】Email
   J1: 【対象】所属チーム
   K1: 対応期日
   L1: 概要・詳細
   M1: 元のメッセージ
   ```

#### 3.2. サービスアカウントへの共有設定

1. スプレッドシートの「共有」ボタンをクリック
2. Cloud Functionsのサービスアカウントメールアドレスを追加
3. 「編集者」権限を付与

#### 3.3. スプレッドシートキーの取得

1. スプレッドシートのURLからキーを取得
   - URL例: `https://docs.google.com/spreadsheets/d/SPREADSHEET_KEY/edit`
   - `SPREADSHEET_KEY` の部分をコピー

### 4. Slack Appの設定

#### 4.1. Slack App作成

1. [Slack API](https://api.slack.com/apps) にアクセス
2. 「Create New App」→「From scratch」を選択
3. App名とWorkspaceを選択

#### 4.2. Bot Token Scopesの設定

「OAuth & Permissions」で以下のスコープを追加:
- `app_mentions:read` - メンションイベントの受信
- `chat:write` - メッセージ送信

**注意**: 問合せ者の特定には`users:read`権限は不要です。`event['user']`から取得したUser IDをそのまま記録します。

#### 4.3. Event Subscriptionsの設定

1. 「Event Subscriptions」を有効化
2. Request URLにCloud FunctionsのURLを設定
   - URLを入力すると、Slackが自動的にURL検証リクエストを送信します
   - エラーが表示された場合は、[トラブルシューティング](#event-subscriptionsのurl検証エラー)を参照してください
3. 以下のBot Eventsを購読:
   - `app_mentions`

#### 4.4. App Installation

1. 「Install App to Workspace」をクリック
2. 権限を承認
3. **Bot User OAuth Token** (`xoxb-...`) をコピー
4. **Signing Secret** をコピー

#### 4.5. チャンネルへの追加

1. 使用したいSlackチャンネルに移動
2. チャンネル設定から「アプリを追加」を選択
3. 作成したBotを追加

### 5. Cloud Functionsのデプロイ

#### 5.1. コードの準備

プロジェクトルートに以下のファイルを配置:
- `main.py`
- `requirements.txt`

#### 5.2. 環境変数の設定

Cloud Functionsの環境変数に以下を設定:

```
SLACK_BOT_TOKEN=xoxb-your-bot-token-here
SLACK_SIGNING_SECRET=your-signing-secret-here
SPREADSHEET_KEY=your-spreadsheet-key-here
PROJECT_ID=your-gcp-project-id
LOCATION=us-central1
```

**GUIでの設定方法:**
1. Cloud Functionsの作成画面で「変数とシークレット」タブを開く
2. 「変数を追加」をクリック
3. 上記の環境変数を1つずつ追加
   - 名前: `SLACK_BOT_TOKEN`、値: `xoxb-...`
   - 名前: `SLACK_SIGNING_SECRET`、値: `...`
   - 名前: `SPREADSHEET_KEY`、値: `...`
   - 名前: `PROJECT_ID`、値: `your-project-id`
   - 名前: `LOCATION`、値: `us-central1`

#### 5.3. デプロイ方法

##### 方法A: GCP Console (GUI) からデプロイ

**新規作成の場合:**

1. [GCP Console](https://console.cloud.google.com/) にログイン
2. 「Cloud Functions」を開く
3. 「関数の作成」をクリック
4. 「第2世代」を選択
5. 以下の設定を行う:
   - **関数名**: `slack-bot-handler`
   - **リージョン**: `us-central1` を推奨
     - ⚠️ **注意**: `asia-northeast1` では Gemini 2.5 Flash Lite が正常に動作しない場合があります
   - **認証**: 「未認証の呼び出しを許可」を選択
6. 「次へ」をクリック
7. **ランタイム設定:**
   - **ランタイム**: `Python 3.11`
   - **エントリーポイント**: `slack_bot_handler` ← **重要: この値を必ず設定**
   - **ソースコード**: 「インラインエディタ」を選択
     - または「ZIP アップロード」で `main.py` と `requirements.txt` を含むZIPをアップロード
8. **変数とシークレット**タブで環境変数を設定（5.2を参照）
9. **コンテナ、ネットワーキング、セキュリティ**タブで以下を設定:
   - **メモリ**: `512 MiB`
   - **CPU**: `1`
   - **タイムアウト**: `300` 秒
   - **同時実行数**: `80`
   - **最小インスタンス数**: `0`
   - **最大インスタンス数**: 空欄（デフォルト）
   - **CPUブースト**: ✅ チェック
10. 「デプロイ」をクリック

**既存のサービスを編集する場合:**

1. [GCP Console](https://console.cloud.google.com/) にログイン
2. 「Cloud Run」を開く（Cloud Functions第2世代はCloud Run上で動作）
3. 編集したいサービス（例: `slack-bot-handler`）を選択
4. 「新しいリビジョンの編集とデプロイ」をクリック
5. 「ソース」タブを開く
6. **エントリーポイントの設定:**
   - 「関数のエントリーポイント」フィールドに `slack_bot_handler` と入力
   - ⚠️ **重要**: デフォルトで `hello_http` などが表示されることがありますが、必ず `slack_bot_handler` に変更してください
7. ソースコードを貼り付ける:
   - `main.py` の内容を貼り付け
   - `requirements.txt` の内容を貼り付け
8. 「変数とシークレット」タブで環境変数を確認・設定（5.2を参照）
9. 「コンテナ、ネットワーキング、セキュリティ」タブで設定を確認
10. 「保存して再デプロイ」をクリック

**⚠️ エントリーポイントの警告が出る場合:**
- 警告メッセージ「指定された関数（エントリーポイント）がソースコードに存在しない可能性があります」が表示された場合
- 「関数のエントリーポイント」フィールドが `slack_bot_handler` になっているか確認
- `main.py` に `@functions_framework.http` デコレータが付いた `slack_bot_handler` 関数が存在するか確認
- 関数名にスペースやタイプミスがないか確認

##### 方法B: gcloud CLI からデプロイ

```bash
gcloud functions deploy slack_bot_handler \
  --gen2 \
  --runtime=python311 \
  --region=us-central1 \
  --source=. \
  --entry-point=slack_bot_handler \
  --trigger-http \
  --allow-unauthenticated \
  --memory=512Mi \
  --timeout=300s \
  --max-instances=100 \
  --min-instances=0 \
  --cpu-boost \
  --set-env-vars SLACK_BOT_TOKEN=xxx,SLACK_SIGNING_SECRET=xxx,SPREADSHEET_KEY=xxx,PROJECT_ID=xxx,LOCATION=us-central1
```

**パラメータの説明:**
- `--gen2`: 第2世代のCloud Functionsを使用
- `--runtime=python311`: Python 3.11ランタイム
- `--region=us-central1`: デプロイするリージョン
- `--source=.`: 現在のディレクトリからソースコードを取得
- `--entry-point=slack_bot_handler`: エントリーポイント関数名
- `--trigger-http`: HTTPトリガーを使用
- `--allow-unauthenticated`: 未認証の呼び出しを許可
- `--memory=512Mi`: メモリを512MBに設定
- `--timeout=300s`: タイムアウトを300秒に設定
- `--max-instances=100`: 最大インスタンス数を100に設定
- `--min-instances=0`: 最小インスタンス数を0に設定（コスト削減）
- `--cpu-boost`: 起動時のCPUブーストを有効化

#### 5.4. URLの取得

デプロイ後、以下の方法でURLを取得:

**GUIの場合:**
1. Cloud Functionsの一覧から関数を選択
2. 「トリガー」タブを開く
3. 「トリガーURL」をコピー

**CLIの場合:**
```bash
gcloud functions describe slack_bot_handler \
  --gen2 \
  --region=us-central1 \
  --format="value(serviceConfig.uri)"
```

取得したURLをSlack AppのEvent Subscriptionsに設定します。

#### 5.5. 設定値の推奨値と注意点

**推奨設定値:**

| 設定項目 | 推奨値 | 説明 |
|---------|--------|------|
| ランタイム | Python 3.11 | 最新の安定版 |
| リージョン | `asia-northeast1` (東京) | 日本からのアクセスが速い<br>⚠️ **注意**: Gemini 2.5 Flash Liteが利用できない場合があります |
| リージョン | `us-central1` (アイオワ) | より多くのモデルが利用可能<br>✅ **推奨**: Gemini 2.5 Flash Liteが確実に動作します |
| メモリ | 512 MiB | 基本的な処理には十分 |
| CPU | 1 | デフォルト値で問題なし |
| タイムアウト | 300秒 (5分) | Vertex AIの処理時間を考慮 |
| 同時実行数 | 80 | デフォルト値で問題なし |
| 最小インスタンス数 | 0 | コスト削減のため |
| 最大インスタンス数 | 100 | 必要に応じて調整 |
| CPUブースト | 有効 | コールドスタートを高速化 |

**注意点:**

1. **リージョンの選択**
   - ⚠️ **重要**: `asia-northeast1` では Gemini 2.5 Flash Lite が正常に動作しない場合があります
   - ✅ **推奨**: `us-central1` を使用してください
   - `LOCATION` 環境変数は、Vertex AIのリージョンと一致させる必要があります
   - 例: Cloud Functionsを `us-central1` にデプロイする場合、`LOCATION=us-central1` を設定

2. **メモリ不足の場合**
   - Vertex AIの処理でメモリ不足が発生する場合は、`1024 MiB` に増やしてください

3. **タイムアウトエラーが発生する場合**
   - Vertex AIの処理が遅い場合は、タイムアウトを `600` 秒（10分）に増やしてください
   - ただし、最大値は `3600` 秒（60分）です

4. **コスト最適化**
   - 最小インスタンス数を `0` に設定することで、リクエストがない場合は課金されません
   - ただし、コールドスタートが発生するため、レスポンス時間が若干遅くなる可能性があります

5. **高トラフィック対応**
   - 同時リクエストが多い場合は、最大インスタンス数を増やすか、同時実行数を調整してください

## ローカルテスト

Cloud Functionsにデプロイする前に、ローカル環境で動作テストを行うことを推奨します。

### クイックスタート

1. **環境変数の設定**
   ```bash
   # Windows PowerShell
   $env:SLACK_BOT_TOKEN="xoxb-your-token"
   $env:SLACK_SIGNING_SECRET="your-secret"
   $env:SPREADSHEET_KEY="your-key"
   $env:PROJECT_ID="your-project-id"
   $env:LOCATION="us-central1"
   ```

2. **依存ライブラリのインストール**
   ```bash
   pip install -r requirements.txt
   ```

3. **ローカルサーバーの起動**
   ```bash
   functions-framework --target=slack_bot_handler --port=8080
   ```

4. **テスト実行**
   - ブラウザで `http://localhost:8080` にアクセス
   - または、curlでテストリクエストを送信

### 詳細な手順

詳細なローカルテスト手順は、`documents/ローカルテスト手順.md` を参照してください。

主なテスト方法:
- **Functions Framework**: ローカルでHTTPサーバーを起動
- **ngrok**: SlackのEvent Subscriptionsと連携してテスト
- **モックテスト**: 外部サービスをモックして単体テスト

## 使用方法

### 基本的な使い方

1. Slackチャンネルでボットにメンションを送る
2. アカウント申請情報や作業依頼を含めてメッセージを送信

**例（単一依頼）**:
```
@Bot 佐藤太郎さんのアカウント作成をお願い。SREチーム、sato@example.com
```

**例（複数依頼）**:
```
@Bot 佐藤太郎さんと田中花子さんのアカウント作成をお願いします。sato@example.com、tanaka@example.com
```

**例（自分のアカウント）**:
```
@Bot 私のアカウント作成をお願いします。アプリチーム、myemail@example.com
```

### メッセージ形式

**文字数制限**: メッセージ本文は500文字以内で入力してください（コスト削減のため）。

ボットは以下の情報を自動抽出します:
- **対象者情報**: 氏名、メールアドレス、所属チーム（正規化）
- **分類**: 大分類（アカウント管理/作業依頼/課題）、中分類、小分類
- **対応期日**: 作業して欲しい期日が明示されている場合
- **問合せ者**: 自動的にSlack User IDが記録されます（例: `U1234567890`）

**所属チームの正規化**:
以下のリストに名寄せされます:
- アプリチーム
- SREチーム（インフラチームも含む）
- 運用保守チーム
- Lookerチーム
- 営業担当
- コンサルティング部

**推奨形式**:
- 「[氏名]さんのアカウント作成をお願い。[所属チーム]、[メールアドレス]」
- 「[氏名]、[所属チーム]、[メールアドレス]でアカウント作成」
- 「私のアカウント作成をお願いします。[所属チーム]、[メールアドレス]」（問合せ者本人のアカウント）

### レスポンス

#### 成功時（単一依頼）

```
お問合せ頂いた内容について、以下の通りスプレッドシートに1件登録しました。認識相違が無いかご確認ください。

📋 スプレッドシート: <リンク|問合せNo1>

【1件目】 (問合せNo: 1)
対象者: 佐藤太郎
メールアドレス: sato@example.com
所属チーム: SREチーム
対応期日: 2024-12-31
分類: アカウント管理
```

#### 成功時（複数依頼）

```
お問合せ頂いた内容について、以下の通りスプレッドシートに2件登録しました。認識相違が無いかご確認ください。

📋 スプレッドシート: <リンク|問合せNo1-2>

【1件目】 (問合せNo: 1)
対象者: 佐藤太郎
メールアドレス: sato@example.com
所属チーム: SREチーム
対応期日: 2024-12-31
分類: アカウント管理

【2件目】 (問合せNo: 2)
対象者: 田中花子
メールアドレス: tanaka@example.com
所属チーム: アプリチーム
対応期日: 2025-01-15
分類: アカウント管理
```

#### エラー時

**文字数超過**:
```
お問合せの内容が長すぎます（{文字数}文字）。500文字以内で再度入力してください。
```

**情報不足**:
```
情報を正しく読み取れませんでした。再度入力してください
```

**アカウント管理でメールアドレス不足**:
```
アカウント管理の依頼には対象者のメールアドレスが必要です。メールアドレスを含めて再度入力してください
```

**システムエラー**:
```
エラーが発生しました。しばらく時間をおいて再度お試しください。
```

### スプレッドシートの確認

1. Googleスプレッドシートを開く
2. 新しい行が自動的に追加されていることを確認（複数の依頼の場合は複数行追加される）
3. 以下の項目が記録されていることを確認:
   - 問合せNo（連番）
   - タイムスタンプ
   - 問合せ者（Slack User ID）
   - 問合せ元Slack URL
   - 大分類、中分類、小分類
   - 【対象】氏名、Email、所属チーム
   - 対応期日
   - 概要・詳細
   - 元のメッセージ

## トラブルシューティング

### Event SubscriptionsのURL検証エラー

**エラーメッセージ**: 「リクエストURLは正しいチャレンジ値で応答しませんでした」または `challenge_failed`

**原因**: URL検証（`url_verification`）リクエストが署名検証で失敗している、または正しく処理されていない

**解決策**:

1. **コードの確認**
   - `main.py` の `slack_bot_handler` 関数で、URL検証が署名検証の**前に**処理されているか確認
   - URL検証リクエストは署名検証をスキップする必要があります

2. **最新のコードに更新**
   - 最新の `main.py` を使用しているか確認
   - コードを更新した場合は、Cloud Functionsを再デプロイしてください

3. **再デプロイ後の確認**
   ```bash
   gcloud functions deploy slack_bot_handler \
     --gen2 \
     --runtime=python311 \
     --region=us-central1 \
     --source=. \
     --entry-point=slack_bot_handler \
     --trigger-http \
     --allow-unauthenticated \
     --set-env-vars SLACK_BOT_TOKEN=xxx,SLACK_SIGNING_SECRET=xxx,SPREADSHEET_KEY=xxx,PROJECT_ID=xxx,LOCATION=us-central1
   ```

4. **Slack Appでの再試行**
   - Slack Appの「Event Subscriptions」ページで「リトライ」ボタンをクリック
   - または、URLを一度削除して再度入力

5. **ログの確認**
   - Cloud Loggingで「URL検証リクエストを受信」というログが出力されているか確認
   - エラーログがないか確認

**正しい処理フロー**:
1. リトライ検出（`X-Slack-Retry-Num` ヘッダーチェック）
2. リクエストボディを取得
3. **URL検証（`url_verification`）を先に処理** ← 重要
4. URL検証でない場合のみ署名検証を実行
5. イベント処理

### エントリーポイントの警告エラー

**エラーメッセージ**: 「指定された関数（エントリーポイント）がソースコードに存在しない可能性があります」

**原因**: Cloud Runの設定でエントリーポイントが `hello_http` などになっているが、実際のコードには `slack_bot_handler` 関数が定義されている

**解決策**:

1. **Cloud Runの設定画面で確認**
   - 「ソース」タブを開く
   - 「関数のエントリーポイント」フィールドを確認
   - 値が `slack_bot_handler` になっているか確認

2. **エントリーポイントを修正**
   - 「関数のエントリーポイント」フィールドに `slack_bot_handler` と入力
   - ⚠️ **重要**: `hello_http` やその他の値が入っている場合は、必ず `slack_bot_handler` に変更

3. **コードの確認**
   - `main.py` に以下の関数が存在するか確認:
     ```python
     @functions_framework.http
     def slack_bot_handler(request: Request) -> tuple[str, int]:
     ```
   - 関数名にタイプミスやスペースがないか確認

4. **再デプロイ**
   - 「保存して再デプロイ」をクリック
   - または、CLIから再デプロイ:
     ```bash
     gcloud functions deploy slack_bot_handler \
       --gen2 \
       --runtime=python311 \
       --region=asia-northeast1 \
       --source=. \
       --entry-point=slack_bot_handler \
       --trigger-http \
       --allow-unauthenticated
     ```

5. **警告が消えることを確認**
   - 再デプロイ後、警告メッセージが消えているか確認
   - エントリーポイントが正しく認識されているか確認

**注意事項**:
- エントリーポイントが間違っていると、関数が実行されずにエラーになります
- 関数名は大文字小文字を区別します（`slack_bot_handler` が正しい）
- `@functions_framework.http` デコレータが必須です

### ボットが反応しない

**原因1: メンションが正しく送信されていない**
- 解決策: ボットがチャンネルに追加されているか確認
- 解決策: `@Bot` の形式でメンションしているか確認

**原因2: Event SubscriptionsのURLが正しくない**
- 解決策: Slack Appの「Event Subscriptions」でURLを確認
- 解決策: Cloud FunctionsのURLが正しいか確認

**原因3: 署名検証エラー**
- 解決策: `SLACK_SIGNING_SECRET` が正しく設定されているか確認
- 解決策: Cloud Loggingでエラーログを確認

### 情報が正しく抽出されない

**原因1: メッセージ形式が不明確**
- 解決策: 対象者のメールアドレスを明確に記載（大分類が「アカウント管理」の場合のみ必須）
- 解決策: 対象者の氏名、所属チームを明確に記載
- 解決策: 「私」や「自分」の言及がある場合は、問合せ者本人のアカウントとして処理されます

**原因2: Gemini APIエラー**

**エラーメッセージ例**: `404 Publisher Model ... was not found or your project does not have access to it`

**原因**: 
- Vertex AI APIが有効化されていない
- モデル名が間違っている（リージョンによって利用可能なモデルが異なる）
- `PROJECT_ID` や `LOCATION` が間違っている

**解決策**:

1. **Vertex AI APIの有効化確認**
   - GCP Console → 「APIとサービス」→「ライブラリ」
   - "Vertex AI API" を検索して有効化されているか確認

2. **モデル名の確認**
   - `main.py` の `GenerativeModel()` で使用しているモデル名を確認
   - **重要**: Gemini 1.5は廃止されているため、`gemini-2.5-flash-lite` を使用してください
   - コードを確認: `model = GenerativeModel("gemini-2.5-flash-lite")` になっているか

3. **環境変数の確認**
   - `PROJECT_ID` が正しいGCPプロジェクトIDになっているか確認
   - `LOCATION` が `asia-northeast1` または `us-central1` になっているか確認
   - Cloud Runの「変数とシークレット」タブで確認

4. **リージョンの変更（重要）**
   - ⚠️ **`asia-northeast1` では Gemini 2.5 Flash Lite が正常に動作しない場合があります**
   - ✅ **推奨**: `us-central1` を使用してください
   - 環境変数 `LOCATION` を `us-central1` に変更して再デプロイ
   - Cloud Runのデプロイリージョンも `us-central1` に変更することを推奨

5. **ログの確認**
   - Cloud Loggingでエラーの詳細を確認
   - エラーメッセージに「was not found」とあれば、モデル名またはリージョンの問題

### スプレッドシートに書き込まれない

**原因1: サービスアカウントに権限がない**
- **エラーメッセージ**: `APIError: [403]: The caller does not have permission`
- **解決策**: 
  1. Googleスプレッドシートを開く
  2. 「共有」ボタンをクリック
  3. サービスアカウントのメールアドレスを追加:
     ```
     949120639074-compute@developer.gserviceaccount.com
     ```
     （プロジェクトによって異なる場合があります。Cloud Runの設定で確認してください）
  4. 権限を「編集者」に設定
  5. 「送信」をクリック
- **確認方法**: 
  1. **Cloud Runの設定画面から確認**:
     - Cloud Run → サービス → 「変数とシークレット」タブ
     - 「サービスアカウント」の項目を確認
  2. **YAMLファイルから確認**:
     - Cloud RunのYAMLファイル（エクスポートした設定ファイル）を開く
     - `serviceAccountName` の項目を確認
     - 例: `serviceAccountName: 949120639074-compute@developer.gserviceaccount.com`
     - このメールアドレスが使用されているサービスアカウントです

**原因2: スプレッドシートキーが間違っている**
- 解決策: `SPREADSHEET_KEY` 環境変数を確認
- 解決策: URLから正しいキーを取得

**原因3: スプレッドシートの形式が正しくない**
- 解決策: 1行目に正しいヘッダーが設定されているか確認（タイムスタンプ、問合せ者、大分類、中分類、小分類、【対象】氏名、【対象】Email、【対象】所属チーム、概要・詳細、元のメッセージ）
- 解決策: スプレッドシートが空でないか確認

### Cloud Functionsのログ確認

Cloud Functions（第2世代）のログはCloud Loggingで確認できます。

#### 方法1: Cloud Runから確認（簡単）

1. [GCP Console](https://console.cloud.google.com/) にログイン
2. 「Cloud Run」を開く
3. サービス名（例: `slack-bot-handler`）をクリック
4. 「オブザーバビリティ」タブを開く
5. 「ログ」セクションで最新のログを確認
   - エラーログは赤色で表示されます
   - タイムスタンプ順に並んでいます

#### 方法2: Cloud Loggingで詳細確認（推奨）

1. [GCP Console](https://console.cloud.google.com/) にログイン
2. 「ロギング」→「ログエクスプローラー」を開く
3. 左側のフィルタで以下を設定:
   - **リソースタイプ**: `cloud_run_revision`
   - **サービス名**: `slack-bot-handler`（あなたのサービス名）
4. 時間範囲を設定（例: 過去1時間）
5. 「ログを実行」をクリック

**ログの見方:**
- **INFO**: 正常な処理（例: 「メンションを受信」「スプレッドシートに書き込み成功」）
- **WARNING**: 警告（例: 「署名検証に失敗しました」）
- **ERROR**: エラー（例: 「Geminiでの情報抽出に失敗」「スプレッドシートへの書き込みに失敗」）

**よく見るべきログ:**
- `メンションを受信: ...` - リクエストが届いているか
- `抽出されたデータ: ...` - Geminiで情報が抽出できているか
- `スプレッドシートに書き込み成功` - 書き込みが成功しているか
- `エラーが発生しました` - エラーの詳細

#### 方法3: gcloud CLIで確認

```bash
# 最新のログを確認
gcloud logging read "resource.type=cloud_run_revision AND resource.labels.service_name=slack-bot-handler" \
  --limit=50 \
  --format=json \
  --region=asia-northeast1

# エラーログのみ確認
gcloud logging read "resource.type=cloud_run_revision AND resource.labels.service_name=slack-bot-handler AND severity>=ERROR" \
  --limit=20 \
  --format=json \
  --region=asia-northeast1
```

#### エラーログの例と対処法

**エラー1: 「署名検証に失敗しました」**
- 原因: `SLACK_SIGNING_SECRET` が間違っている
- 解決策: 環境変数を確認

**エラー2: 「Geminiでの情報抽出に失敗」**
- 原因: Vertex AI APIのエラー、プロジェクトIDやリージョンが間違っている
- 解決策: `PROJECT_ID` と `LOCATION` を確認、Vertex AI APIが有効化されているか確認

**エラー3: 「スプレッドシートへの書き込みに失敗」**
- 原因: サービスアカウントに権限がない、スプレッドシートキーが間違っている
- 解決策: スプレッドシートの共有設定を確認、`SPREADSHEET_KEY` を確認

**エラー4: 「Slackへの返信に失敗」**
- 原因: `SLACK_BOT_TOKEN` が間違っている、ボットがチャンネルに追加されていない
- 解決策: 環境変数を確認、ボットがチャンネルに追加されているか確認

## よくある質問

### Q1. メールアドレスが必須なのはなぜですか？

A. 大分類が「アカウント管理」の場合のみ、対象者のメールアドレスが必須です。アカウント作成にはメールアドレスが必要なためです。それ以外の大分類（「作業依頼」「課題」）では、メールアドレス、氏名、所属チームは任意です。

### Q2. 1回のメッセージで複数の依頼を送れますか？

A. はい、対応しています。1つのメッセージに複数の依頼が含まれている場合、AIが自動的に分割して、それぞれを行としてスプレッドシートに登録します。

### Q3. 問合せ者とは何ですか？

A. 問合せ者は、Slackでメッセージを送信したユーザーのUser IDです。システムが自動的に`event['user']`からUser IDを取得して記録します（例: `U1234567890`）。「私」や「自分」のアカウントという言及がある場合、対象者は問合せ者本人として処理されます。`users:read`権限は不要です。

### Q4. 所属チームはどのように正規化されますか？

A. 以下のリストに名寄せされます：アプリチーム、SREチーム、運用保守チーム、Lookerチーム、営業担当、コンサルティング部。「インフラチーム」は「SREチーム」に正規化されます。

### Q5. 複数のスプレッドシートに対応できますか？

A. 現在のバージョンでは1つのスプレッドシートのみ対応しています。複数対応する場合は、コードの修正が必要です。

### Q6. 他の情報も抽出できますか？

A. はい、`main.py` の `extract_info_with_gemini` 関数内のプロンプトを修正することで、追加の情報を抽出できます。

### Q7. コストはどのくらいかかりますか？

A. Vertex AI (Gemini 2.5 Flash Lite) は低コストのモデルです。Cloud Functionsの実行時間とAPI呼び出し回数に応じて課金されます。詳細はGCPの料金ページを参照してください。なお、Gemini 1.5は廃止されているため、Gemini 2.5を使用してください。

### Q8. セキュリティは大丈夫ですか？

A. はい、以下のセキュリティ対策を実装しています:
- Slack署名検証によるリクエスト検証
- ADCによるGoogle認証
- リトライ対策による二重書き込み防止

### Q9. エラーが発生した場合の通知方法は？

A. 現在はSlackへの返信のみです。将来的にメール通知やChat通知を追加することも可能です。

### Q10. メッセージの文字数制限はありますか？

A. はい、500文字以内で入力してください。コスト削減のため、Vertex AIに長すぎる文章を解析させることを防いでいます。500文字を超える場合はエラーメッセージが返されます。

## サポート

問題が解決しない場合は、以下を確認してください:
1. Cloud Loggingのエラーログ
2. Slack Appの設定
3. GCPの権限設定
4. スプレッドシートの共有設定
