# ローカルテスト手順

Cloud Functionsにデプロイする前に、ローカル環境で動作テストを行う手順です。

## 目次

1. [前提条件](#前提条件)
2. [環境変数の設定](#環境変数の設定)
3. [Functions Frameworkを使用したローカル実行](#functions-frameworkを使用したローカル実行)
4. [テスト方法](#テスト方法)
5. [トラブルシューティング](#トラブルシューティング)

## 前提条件

- Python 3.11以上がインストールされていること
- GCP認証情報が設定されていること（ADC）
- 必要なライブラリがインストールされていること

## 環境変数の設定

### 1. 環境変数ファイルの作成

プロジェクトルートに `.env` ファイルを作成（`.env.example` をコピーして編集）：

```bash
cp env.example .env
```

`.env` ファイルを編集して、実際の値を設定：

```env
SLACK_BOT_TOKEN=xoxb-your-actual-bot-token
SLACK_SIGNING_SECRET=your-actual-signing-secret
SPREADSHEET_KEY=your-actual-spreadsheet-key
PROJECT_ID=your-actual-gcp-project-id
LOCATION=us-central1
```

### 2. 環境変数の読み込み方法

#### Windows (PowerShell)

```powershell
# .envファイルから環境変数を読み込む（手動）
$env:SLACK_BOT_TOKEN="xoxb-your-token"
$env:SLACK_SIGNING_SECRET="your-secret"
$env:SPREADSHEET_KEY="your-key"
$env:PROJECT_ID="your-project-id"
$env:LOCATION="us-central1"
```

#### Windows (Command Prompt)

```cmd
set SLACK_BOT_TOKEN=xoxb-your-token
set SLACK_SIGNING_SECRET=your-secret
set SPREADSHEET_KEY=your-key
set PROJECT_ID=your-project-id
set LOCATION=us-central1
```

#### Linux/Mac

```bash
export SLACK_BOT_TOKEN=xoxb-your-token
export SLACK_SIGNING_SECRET=your-secret
export SPREADSHEET_KEY=your-key
export PROJECT_ID=your-project-id
export LOCATION=us-central1
```

または、`python-dotenv` を使用する方法（推奨）：

```bash
pip install python-dotenv
```

`main.py` の先頭に以下を追加：

```python
from dotenv import load_dotenv
load_dotenv()
```

### 3. GCP認証情報の設定

ローカル環境でADCを使用する場合：

```bash
# GCP認証情報を設定
gcloud auth application-default login
```

または、サービスアカウントキーを使用する場合：

```bash
export GOOGLE_APPLICATION_CREDENTIALS="path/to/service-account-key.json"
```

## Functions Frameworkを使用したローカル実行

### 1. 依存ライブラリのインストール

```bash
pip install -r requirements.txt
```

### 2. ローカルサーバーの起動

```bash
functions-framework --target=slack_bot_handler --port=8080
```

または、Pythonモジュールとして実行：

```bash
python -m functions_framework --target=slack_bot_handler --port=8080
```

サーバーが起動すると、以下のようなメッセージが表示されます：

```
 * Serving Flask app 'main'
 * Debug mode: off
WARNING: This is a development server. Do not use it in a production deployment.
 * Running on http://127.0.0.1:8080
```

### 3. サーバーの確認

別のターミナルで以下を実行して動作確認：

```bash
curl http://localhost:8080
```

または、ブラウザで `http://localhost:8080` にアクセス

## テスト方法

### 方法1: curlを使用した直接テスト

#### URL検証テスト（url_verification）

```bash
curl -X POST http://localhost:8080 \
  -H "Content-Type: application/json" \
  -d '{
    "type": "url_verification",
    "challenge": "test-challenge-12345"
  }'
```

期待されるレスポンス: `test-challenge-12345`

#### メンションイベントのテスト

**注意**: 実際のSlack署名を生成する必要があります。以下のPythonスクリプトを使用してください。

`test_local.py` を作成：

```python
import json
import hmac
import hashlib
import time
import requests
from urllib.parse import quote

def generate_slack_signature(body: str, timestamp: str, signing_secret: str) -> str:
    """Slack署名を生成"""
    sig_basestring = f"v0:{timestamp}:{body}"
    signature = hmac.new(
        signing_secret.encode('utf-8'),
        sig_basestring.encode('utf-8'),
        hashlib.sha256
    ).hexdigest()
    return f"v0={signature}"

# テストデータ
signing_secret = "your-signing-secret"  # .envから取得
timestamp = str(int(time.time()))
payload = {
    "type": "event_callback",
    "event": {
        "type": "app_mention",
        "channel": "C1234567890",
        "ts": "1234567890.123456",
        "text": "<@U123456> 佐藤太郎さんのアカウント作成をお願い。営業部、sato@example.com"
    }
}

body = json.dumps(payload)
signature = generate_slack_signature(body, timestamp, signing_secret)

# リクエスト送信
headers = {
    "Content-Type": "application/json",
    "X-Slack-Request-Timestamp": timestamp,
    "X-Slack-Signature": signature
}

response = requests.post(
    "http://localhost:8080",
    headers=headers,
    data=body
)

print(f"Status: {response.status_code}")
print(f"Response: {response.text}")
```

実行：

```bash
python test_local.py
```

### 方法2: ngrokを使用したSlack連携テスト

実際のSlackからイベントを受信してテストする方法です。

#### 1. ngrokのインストール

[ngrok](https://ngrok.com/) をダウンロードしてインストール

#### 2. ngrokトンネルの作成

```bash
ngrok http 8080
```

ngrokが以下のようなURLを表示します：

```
Forwarding  https://xxxx-xxxx-xxxx.ngrok.io -> http://localhost:8080
```

#### 3. Slack Appの設定

1. [Slack API](https://api.slack.com/apps) にアクセス
2. アプリを選択
3. 「Event Subscriptions」を開く
4. Request URLに `https://xxxx-xxxx-xxxx.ngrok.io` を設定
5. 「Save Changes」をクリック

#### 4. テスト実行

1. Functions Frameworkサーバーを起動（上記参照）
2. ngrokトンネルを起動
3. Slackチャンネルでボットにメンションを送信
4. ローカルサーバーのログを確認

### 方法3: テストスクリプトを使用（推奨）

プロジェクトルートに `test_local.py` が用意されています。このスクリプトを使用すると、簡単にテストできます。

#### 1. 環境変数の設定

`.env` ファイルを作成するか、環境変数を直接設定：

```bash
# Windows PowerShell
$env:SLACK_BOT_TOKEN="xoxb-your-token"
$env:SLACK_SIGNING_SECRET="your-secret"
$env:SPREADSHEET_KEY="your-key"
$env:PROJECT_ID="your-project-id"
$env:LOCATION="us-central1"
```

#### 2. Functions Frameworkサーバーの起動

別のターミナルで：

```bash
functions-framework --target=slack_bot_handler --port=8080
```

#### 3. テストスクリプトの実行

```bash
python test_local.py
```

このスクリプトは以下をテストします：
- URL検証（url_verification）
- リトライヘッダーの処理
- メンションイベントの処理（署名検証含む）

**注意**: 実際のGemini APIやSlack APIは呼び出されませんが、リクエストの処理フローは確認できます。

### 方法4: モックテストスクリプト

完全にモックした環境でテストする場合：

`test_mock.py` を作成：

```python
"""モックテスト用スクリプト"""
import os
import sys
from unittest.mock import Mock, patch, MagicMock
from main import slack_bot_handler

# 環境変数を設定
os.environ['SLACK_BOT_TOKEN'] = 'xoxb-test-token'
os.environ['SLACK_SIGNING_SECRET'] = 'test-secret'
os.environ['SPREADSHEET_KEY'] = 'test-spreadsheet-key'
os.environ['PROJECT_ID'] = 'test-project-id'
os.environ['LOCATION'] = 'us-central1'

def test_url_verification():
    """URL検証のテスト"""
    request = Mock()
    request.headers = {}
    request.get_data.return_value = b''
    request.get_json.return_value = {
        'type': 'url_verification',
        'challenge': 'test-challenge-123'
    }
    
    response, status = slack_bot_handler(request)
    assert status == 200
    assert response == 'test-challenge-123'
    print("✓ URL検証テスト成功")

def test_app_mention_mock():
    """メンションイベントのモックテスト"""
    # GeminiとSlack、スプレッドシートをモック
    with patch('main.extract_info_with_gemini') as mock_gemini, \
         patch('main.write_to_spreadsheet') as mock_sheet, \
         patch('main.send_slack_reply') as mock_slack:
        
        # モックの設定
        mock_gemini.return_value = {
            'name': '佐藤太郎',
            'email': 'sato@example.com',
            'department': '営業部'
        }
        mock_sheet.return_value = True
        mock_slack.return_value = None
        
        # リクエストの作成
        request = Mock()
        request.headers = {}
        request.get_data.return_value = b'{"type":"event_callback","event":{"type":"app_mention","channel":"C123","ts":"123.456","text":"<@U123> テストメッセージ"}}'
        request.get_json.return_value = {
            'type': 'event_callback',
            'event': {
                'type': 'app_mention',
                'channel': 'C1234567890',
                'ts': '1234567890.123456',
                'text': '<@U123456> 佐藤太郎さんのアカウント作成をお願い。営業部、sato@example.com'
            }
        }
        
        response, status = slack_bot_handler(request)
        assert status == 200
        assert mock_gemini.called
        assert mock_sheet.called
        assert mock_slack.called
        print("✓ メンションイベントテスト成功")

if __name__ == '__main__':
    print("ローカルテストを開始...")
    test_url_verification()
    test_app_mention_mock()
    print("すべてのテストが完了しました！")
```

実行：

```bash
python test_mock.py
```

## トラブルシューティング

### ポートが既に使用されている

エラー: `Address already in use`

解決策: 別のポートを指定

```bash
functions-framework --target=slack_bot_handler --port=8081
```

### 環境変数が読み込まれない

エラー: `None` が返される

解決策1: 環境変数を直接設定

```bash
# Windows PowerShell
$env:SLACK_BOT_TOKEN="your-token"
functions-framework --target=slack_bot_handler --port=8080
```

解決策2: `python-dotenv` を使用

`main.py` の先頭に追加：

```python
from dotenv import load_dotenv
load_dotenv()
```

### GCP認証エラー

エラー: `Could not automatically determine credentials`

解決策: ADCを設定

```bash
gcloud auth application-default login
```

### Slack署名検証エラー

エラー: `Invalid signature`

解決策: 
- `SLACK_SIGNING_SECRET` が正しく設定されているか確認
- テストスクリプトで署名生成ロジックを確認
- タイムスタンプが5分以内であることを確認

### Vertex AI APIエラー

エラー: `Permission denied` または `API not enabled`

解決策:
1. Vertex AI APIが有効化されているか確認
2. サービスアカウントに適切な権限があるか確認
3. `PROJECT_ID` と `LOCATION` が正しいか確認

## デバッグのヒント

### ログレベルの変更

`main.py` でログレベルを変更：

```python
logging.basicConfig(level=logging.DEBUG)  # INFOからDEBUGに変更
```

### リクエスト/レスポンスの確認

Functions Frameworkサーバーのコンソールにリクエストとレスポンスが表示されます。

### ステップバイステップデバッグ

VS CodeやPyCharmなどのIDEを使用してブレークポイントを設定し、デバッグ実行できます。

## 次のステップ

ローカルテストが成功したら、Cloud Functionsにデプロイしてください。

デプロイ手順は `documents/利用マニュアル.md` の「5. Cloud Functionsのデプロイ」セクションを参照してください。
