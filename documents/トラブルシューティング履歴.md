# トラブルシューティング履歴

このドキュメントは、Slackアカウント申請自動化システムのデプロイ・設定時に発生したエラーとその解決方法を時系列でまとめたものです。
同じような問題が発生した際の参考としてご活用ください。

## 目次

1. [Slack URL検証エラー](#1-slack-url検証エラー)
2. [エントリーポイントの警告エラー](#2-エントリーポイントの警告エラー)
3. [Gemini APIエラー（モデル名・リージョン問題）](#3-gemini-apiエラーモデル名リージョン問題)
4. [Google Sheets API未有効化エラー](#4-google-sheets-api未有効化エラー)
5. [サービスアカウント権限エラー](#5-サービスアカウント権限エラー)

---

## 1. Slack URL検証エラー

### 発生時期
初期デプロイ時

### エラーメッセージ
```
challenge_failed
```

### 症状
- SlackのEvent SubscriptionsでURLを設定した際にエラーが発生
- URL検証が失敗する

### 原因
- `url_verification` イベントの処理が、署名検証の後に実行されていた
- URL検証時には署名が含まれていないため、署名検証でエラーになっていた

### 解決方法
`main.py` の `slack_bot_handler` 関数で、`url_verification` の処理を署名検証より前に移動：

```python
def slack_bot_handler(request):
    # URL検証を最初に処理（署名検証より前）
    if request.method == 'POST':
        data = request.get_json()
        if data and data.get('type') == 'url_verification':
            return data.get('challenge'), 200
    
    # その後、署名検証を実行
    # ...
```

また、`request.get_data()` を `request.get_data(cache=True)` に変更して、リクエストボディを複数回読み込めるようにしました。

### 参考
- `利用マニュアル.md` の「Event SubscriptionsのURL検証エラー」セクション

---

## 2. エントリーポイントの警告エラー

### 発生時期
Cloud Functions作成時

### エラーメッセージ
```
指定された関数（エントリーポイント）がソースコードに存在しない場合が有る
```

### 症状
- Cloud Functionsでソースコードを貼り付けた際に警告が表示される
- デプロイは成功するが、実行時にエラーになる可能性がある

### 原因
- Cloud Runのエントリーポイントがデフォルト値（例: `hello_http`）のままになっていた
- 実際の関数名は `slack_bot_handler` だった

### 解決方法
Cloud Runの設定でエントリーポイントを `slack_bot_handler` に変更：

**GUIから変更:**
1. Cloud Run → サービス → 「変数とシークレット」タブ
2. 「エントリーポイント」を `slack_bot_handler` に設定

**CLIから変更:**
```bash
gcloud run services update slack-bot-handler \
  --region=us-central1 \
  --set-env-vars FUNCTION_TARGET=slack_bot_handler
```

### 参考
- `利用マニュアル.md` の「エントリーポイントの警告エラー」セクション

---

## 3. Gemini APIエラー（モデル名・リージョン問題）

### 発生時期
実行時

### エラーメッセージ（複数回発生）

**エラー1: モデルが見つからない**
```
404 Publisher Model `projects/test-yama-haj-2025/locations/asia-northeast1/publishers/google/models/gemini-1.5-flash-001` was not found
```

**エラー2: リージョン不一致**
```
404 Publisher Model `projects/test-yama-haj-2025/locations/us-central1/publishers/google/models/gemini-1.5-flash` was not found
```

### 症状
- Vertex AI (Gemini) での情報抽出が失敗する
- モデルが見つからないエラーが発生

### 原因
1. **モデル名の問題**:
   - `gemini-1.5-flash-001` が廃止されていた
   - `gemini-1.5-flash`（バージョンなし）も動作しなかった
   
2. **リージョンの問題**:
   - `asia-northeast1` では Gemini 2.5 Flash Lite が利用できない場合がある
   - `LOCATION` 環境変数がデフォルトで `us-central1` になっていなかった

### 解決方法

**ステップ1: モデル名を更新**
`main.py` の `extract_info_with_gemini` 関数で、モデル名を変更：

```python
# 変更前
model = GenerativeModel("gemini-1.5-flash-001")

# 変更後
model = GenerativeModel("gemini-2.5-flash-lite")
```

**ステップ2: リージョンを us-central1 に統一**
1. `main.py` のデフォルト `LOCATION` を `us-central1` に変更
2. Cloud Runの環境変数 `LOCATION` を `us-central1` に設定
3. Cloud Runのデプロイリージョンも `us-central1` に変更

**ステップ3: デバッグログの追加**
モデル名とリージョンを確認するためのログを追加：

```python
logger.info(f"Vertex AI初期化: PROJECT_ID={PROJECT_ID}, LOCATION={LOCATION}")
logger.info(f"使用するモデル: {model_name} (リージョン: {LOCATION})")
```

### 最終的な設定
- **モデル名**: `gemini-2.5-flash-lite`
- **リージョン**: `us-central1`（推奨）
- **環境変数**: `LOCATION=us-central1`

### 参考
- `利用マニュアル.md` の「Gemini APIエラー」セクション
- `設計書.md` のモデル名も更新済み

---

## 4. Google Sheets API未有効化エラー

### 発生時期
スプレッドシートへの書き込み時

### エラーメッセージ
```
gspread.exceptions.APIError: APIError: [403]: Google Sheets API has not been used in project 949120639074 before or it is disabled. 
Enable it by visiting https://console.developers.google.com/apis/api/sheets.googleapis.com/overview?project=949120639074
```

### 症状
- スプレッドシートへの書き込みが失敗する
- エラーログに空のエラーメッセージが表示される（`str(e)` が空文字列を返していた）

### 原因
- Google Sheets APIが有効化されていなかった
- エラーハンドリングが不十分で、詳細なエラー情報が取得できていなかった

### 解決方法

**ステップ1: Google Sheets APIを有効化**
1. GCP Console → 「APIとサービス」→「ライブラリ」
2. "Google Sheets API" を検索
3. 「有効にする」をクリック
4. または、エラーメッセージに表示されているURLから直接有効化

**ステップ2: エラーハンドリングの改善**
`main.py` の `write_to_spreadsheet` 関数で、詳細なエラー情報をログに出力：

```python
except Exception as e:
    import traceback
    logger.error(f"スプレッドシートへの書き込みに失敗: {str(e)}")
    logger.error(f"エラー詳細: {traceback.format_exc()}")
    raise
```

**ステップ3: デバッグログの追加**
処理の各ステップでログを出力：

```python
logger.info("スプレッドシートへの書き込み開始")
logger.info("認証情報の取得に成功")
logger.info("gspreadクライアントの初期化に成功")
logger.info("スプレッドシートを開く")
```

### 確認方法
- GCP Console → 「APIとサービス」→「有効なAPI」
- "Google Sheets API" が表示されていることを確認

### 参考
- `利用マニュアル.md` の「Google Sheets APIの有効化」セクション
- `利用マニュアル.md` の「スプレッドシートに書き込まれない」セクション

---

## 5. サービスアカウント権限エラー

### 発生時期
Google Sheets API有効化後

### エラーメッセージ
```
gspread.exceptions.APIError: APIError: [403]: The caller does not have permission
```

### 症状
- Google Sheets APIは有効化済み
- 認証情報の取得は成功
- しかし、スプレッドシートを開く際に権限エラーが発生

### 原因
- サービスアカウントにスプレッドシートへのアクセス権限が付与されていなかった
- スプレッドシートの共有設定で、サービスアカウントのメールアドレスが追加されていなかった

### 解決方法

**ステップ1: サービスアカウントのメールアドレスを確認**

**方法1: Cloud Runの設定画面から確認**
1. Cloud Run → サービス → 「変数とシークレット」タブ
2. 「サービスアカウント」の項目を確認

**方法2: YAMLファイルから確認**
1. Cloud RunのYAMLファイル（エクスポートした設定ファイル）を開く
2. `serviceAccountName` の項目を確認
3. 例: `serviceAccountName: 949120639074-compute@developer.gserviceaccount.com`

**ステップ2: スプレッドシートにサービスアカウントを追加**
1. Googleスプレッドシートを開く
2. 「共有」ボタンをクリック
3. サービスアカウントのメールアドレスを追加:
   ```
   949120639074-compute@developer.gserviceaccount.com
   ```
   （プロジェクトによって異なります）
4. 権限を「編集者」に設定
5. 「送信」をクリック

### サービスアカウントの確認方法まとめ

**デフォルトのサービスアカウント:**
```
PROJECT_NUMBER-compute@developer.gserviceaccount.com
```

**プロジェクト番号の確認方法:**
- GCP Console → 「ホーム」→ プロジェクト番号を確認
- または、Cloud RunのYAMLファイルの `namespace` を確認

### 参考
- `利用マニュアル.md` の「サービスアカウントへの共有設定」セクション
- `利用マニュアル.md` の「スプレッドシートに書き込まれない」セクション

---

## エラー解決の流れまとめ

### 時系列でのエラー発生順序

1. **Slack URL検証エラー** → URL検証の処理順序を修正
2. **エントリーポイントエラー** → Cloud Runの設定でエントリーポイントを修正
3. **Gemini APIエラー** → モデル名とリージョンを修正（複数回）
   - `gemini-1.5-flash-001` → `gemini-1.5-flash` → `gemini-2.5-flash-lite`
   - `asia-northeast1` → `us-central1`
4. **Google Sheets API未有効化** → APIを有効化
5. **サービスアカウント権限エラー** → スプレッドシートの共有設定で権限を付与

### 重要なポイント

1. **エラーログの確認**
   - Cloud Loggingで詳細なエラーメッセージを確認
   - `traceback.format_exc()` を使用してスタックトレースを出力

2. **段階的なデバッグ**
   - 各処理ステップでログを出力して、どこで失敗しているか特定
   - 正常に動作している部分とエラーが発生している部分を明確に分ける

3. **環境変数の確認**
   - Cloud Runの設定で環境変数が正しく設定されているか確認
   - デフォルト値と実際の値が一致しているか確認

4. **APIの有効化**
   - 必要なAPIがすべて有効化されているか確認
   - Vertex AI API、Google Sheets APIなど

5. **権限の確認**
   - サービスアカウントに必要な権限が付与されているか確認
   - スプレッドシートの共有設定を確認

---

## 今後の参考情報

### よくあるエラーパターン

1. **403エラー**: 権限の問題
   - APIが有効化されていない
   - サービスアカウントに権限がない

2. **404エラー**: リソースが見つからない
   - モデル名が間違っている
   - リージョンが間違っている
   - スプレッドシートキーが間違っている

3. **署名検証エラー**: Slackの設定問題
   - `SLACK_SIGNING_SECRET` が間違っている
   - URL検証の処理順序が間違っている

### デバッグのコツ

1. **ログを活用する**
   - 各処理ステップでログを出力
   - エラー時は `traceback.format_exc()` で詳細情報を取得

2. **エラーメッセージを読む**
   - エラーメッセージには解決のヒントが含まれている
   - URLが含まれている場合は、そこから直接設定できる場合がある

3. **段階的に確認する**
   - 正常に動作している部分とエラーが発生している部分を分ける
   - 一つずつ問題を解決していく

4. **設定を再確認する**
   - 環境変数が正しく設定されているか
   - APIが有効化されているか
   - 権限が付与されているか

---

## 関連ドキュメント

- `利用マニュアル.md`: 詳細な設定手順とトラブルシューティング
- `設計書.md`: システムの設計とアーキテクチャ
- `ローカルテスト手順.md`: ローカル環境でのテスト方法
- `要件定義書.md`: システムの要件定義

---

**最終更新日**: 2026年1月16日
**作成者**: システム開発チーム
