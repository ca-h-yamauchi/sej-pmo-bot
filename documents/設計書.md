# Slack アカウント申請自動化システム 設計書

## 1. システムアーキテクチャ

### 1.1. 全体構成

```
┌─────────────┐
│   Slack     │
│   Workspace │
└──────┬──────┘
       │ HTTP POST (Event API)
       │
       ▼
┌─────────────────────────────────┐
│  Google Cloud Functions         │
│  (第2世代 / HTTP Trigger)       │
│                                 │
│  ┌───────────────────────────┐  │
│  │  slack_bot_handler()     │  │
│  │  - 署名検証               │  │
│  │  - リトライ対策           │  │
│  │  - イベント処理           │  │
│  └───────────┬───────────────┘  │
│              │                   │
│  ┌───────────▼───────────────┐  │
│  │  extract_info_with_gemini()│  │
│  │  (Vertex AI呼び出し)       │  │
│  │  (User IDをコンテキストに) │  │
│  └───────────┬───────────────┘  │
│              │                   │
│  ┌───────────▼───────────────┐  │
│  │  write_to_spreadsheet()   │  │
│  │  (Google Sheets API)      │  │
│  │  (複数件ループ処理)        │  │
│  └───────────┬───────────────┘  │
│              │                   │
│  ┌───────────▼───────────────┐  │
│  │  send_slack_reply()       │  │
│  │  (Slack Web API)          │  │
│  └───────────────────────────┘  │
└─────────────────────────────────┘
       │                    │
       │                    │
       ▼                    ▼
┌──────────────┐    ┌──────────────┐
│ Vertex AI    │    │ Google Sheets│
│ (Gemini 2.5  │    │              │
│  Flash Lite) │    │              │
└──────────────┘    └──────────────┘
```

### 1.2. データフロー

1. **イベント受信**
   - Slackから `app_mention` イベントを受信
   - HTTPヘッダーでリトライ検出
   - 署名検証でリクエストの正当性を確認

2. **問合せ者の特定**
   - `event['user']` からUser IDを取得
   - User IDをそのまま `inquirer_name` として使用（`users:read`権限なしでも動作）

3. **文字数チェック**
   - メッセージ本文が500文字以内であることを確認（コスト削減のため）
   - 500文字を超える場合はエラーメッセージを返して処理を中断

4. **情報抽出**
   - メンションテキストからボットIDを除去
   - Vertex AI (Gemini) にテキストと問合せ者名を送信して構造化データを抽出
   - JSON配列形式で複数の依頼を取得（1件のメッセージに複数の依頼がある場合に対応）

5. **データ保存**
   - バリデーション（配列が空でないこと、大分類が「アカウント管理」の場合のみ`target_email`が必須）
   - Googleスプレッドシートに追記（リストの各要素を行として追加）
   - タイムスタンプ付きで記録

6. **レスポンス送信**
   - 処理結果をSlackスレッドに返信
   - 成功時: 「お問合せ頂いた内容について、以下の通りスプレッドシートに{件数}件登録しました。認識相違が無いかご確認ください。」から始まるメッセージを送信
   - 失敗時: 適切なエラーメッセージを送信

## 2. 関数設計

### 2.1. `slack_bot_handler(request: Request) -> tuple[str, int]`

**役割**: Cloud Functionsのエントリーポイント

**処理フロー**:
1. リトライ検出（`X-Slack-Retry-Num` ヘッダーチェック）
2. 署名検証（`SLACK_SIGNING_SECRET` を使用）
3. URL検証（`url_verification` イベント対応）
4. イベントタイプ判定（`event_callback` のみ処理）
5. メンションイベント処理
   - User ID取得（問合せ者の特定、`users:read`権限不要）
   - 文字数チェック（500文字以内）
   - Geminiで情報抽出
   - バリデーション（アカウント管理の場合のみメールアドレス必須）
   - スプレッドシートに書き込み（複数件対応）
   - Slackに返信（確認を促すメッセージ）
6. エラーハンドリング

**戻り値**: `(レスポンス本文, HTTPステータスコード)`

### 2.2. `extract_info_with_gemini(text: str, inquirer_name: str) -> List[Dict[str, Any]]`

**役割**: Vertex AIを使用した情報抽出

**処理内容**:
- Vertex AI (Gemini 2.5 Flash Lite) の初期化
- プロンプト生成（問合せ者名をコンテキストとして埋め込み、JSON配列形式で抽出指示）
- API呼び出し（Temperature: 0, JSONモード強制）
- レスポンスパース（コードブロック除去）
- 配列形式で抽出データのリストを返却（複数依頼に対応）

**戻り値**: `[{"target_name": str|null, "target_email": str|null, "target_team": str|null, "category_large": str, "category_medium": str|null, "category_small": str|null, "details": str|null}, ...]`

**例外処理**: JSONパースエラー、API呼び出しエラーをキャッチして再スロー

### 2.3. `write_to_spreadsheet(inquirer_name: str, extracted_data_list: List[Dict[str, Any]], original_message: str, slack_url: str) -> tuple[bool, List[int], List[int]]`

**役割**: Googleスプレッドシートへのデータ書き込み（複数件対応）

**処理内容**:
- ADC (Application Default Credentials) で認証
- スプレッドシートを開く（`SPREADSHEET_KEY` を使用）
- 問合せNoを生成（既存の最大値+1）
- タイムスタンプ生成
- リストの各要素を行として最終行に追記（ループ処理）
- 各行の構成: `[問合せNo, タイムスタンプ, 問合せ者, 問合せ元Slack URL, 大分類, 中分類, 小分類, 【対象】氏名, 【対象】Email, 【対象】所属チーム, 対応期日, 概要・詳細, 元のメッセージ]`

**戻り値**: `(成功時True, 書き込んだ行番号のリスト, 書き込んだ問合せNoのリスト)`

**前提条件**: スプレッドシートの1行目にヘッダーが存在すること

### 2.4. `send_slack_reply(channel, thread_ts, message) -> None`

**役割**: Slackスレッドへの返信送信

**処理内容**:
- Slack WebClientの初期化（`SLACK_BOT_TOKEN` を使用）
- `chat.postMessage` API呼び出し
- スレッドに返信（`thread_ts` を使用）

**例外処理**: API呼び出しエラーをキャッチして再スロー

## 3. セキュリティ設計

### 3.1. 認証・認可

- **Slack署名検証**: `SLACK_SIGNING_SECRET` を使用してリクエストの正当性を検証
- **問合せ者の特定**: `event['user']` からUser IDを取得（`users:read`権限不要）
- **Google認証**: ADC (Application Default Credentials) を使用
  - Cloud Functionsのサービスアカウントに必要な権限を付与
  - スプレッドシートへの読み書き権限が必要

### 3.2. リトライ対策

- `X-Slack-Retry-Num` ヘッダーが存在する場合、処理をスキップして即座に200を返す
- 二重書き込みを防止

### 3.3. エラーハンドリング

- すべての関数で例外処理を実装
- Cloud Loggingにエラーログを出力
- ユーザーには適切なエラーメッセージを返信

## 4. データ構造

### 4.1. スプレッドシート構造

| 列 | 項目名 | 説明 |
|---|---|---|
| A | **問合せNo** | 連番（自動採番） |
| B | タイムスタンプ | `YYYY-MM-DD HH:MM:SS` 形式 |
| C | **問合せ者** | Slack User ID（`inquirer_name`） |
| D | **問合せ元Slack URL** | メッセージへのリンク |
| E | 大分類 | `category_large`（アカウント管理/作業依頼/課題） |
| F | 中分類 | `category_medium`（空欄可） |
| G | 小分類 | `category_small`（空欄可） |
| H | **【対象】氏名** | `target_name`（空欄可） |
| I | **【対象】Email** | `target_email`（大分類が「アカウント管理」の場合のみ必須、それ以外は空欄可） |
| J | **【対象】所属チーム** | `target_team`（正規化済み、空欄可） |
| K | 対応期日 | `due_date`（YYYY-MM-DD形式、空欄可） |
| L | 概要・詳細 | `details`（空欄可） |
| M | 元のメッセージ | Slackから受信した元のテキスト |

### 4.2. Gemini抽出データ構造

```json
[
  {
    "target_name": "対象者の氏名またはnull",
    "target_email": "メールアドレスまたはnull",
    "target_team": "正規化された所属チーム名またはnull",
    "category_large": "アカウント管理|作業依頼|課題",
    "category_medium": "中分類またはnull",
    "category_small": "小分類またはnull",
    "details": "概要・詳細またはnull",
    "due_date": "対応期日（YYYY-MM-DD形式）またはnull"
  }
]
```

**注意**: 1つのメッセージに複数の依頼がある場合は、配列に複数の要素が含まれる。

## 5. 環境変数

| 変数名 | 説明 | 必須 |
|---|---|---|
| `SLACK_BOT_TOKEN` | Slack Bot User OAuth Token | 必須 |
| `SLACK_SIGNING_SECRET` | Slack Signing Secret | 必須 |
| `SPREADSHEET_KEY` | Googleスプレッドシートのキー | 必須 |
| `PROJECT_ID` | GCPプロジェクトID | 必須 |
| `LOCATION` | Vertex AIのリージョン（デフォルト: `asia-northeast1`） | 任意 |

## 6. 依存ライブラリ

- `functions-framework>=3.5.0`: Cloud Functionsエントリーポイント
- `slack-sdk>=3.27.0`: Slack API操作
- `google-cloud-aiplatform>=1.38.0`: Vertex AI操作
- `gspread>=5.12.0`: Google Sheets操作
- `google-auth>=2.23.0`: Google認証

## 7. ロギング設計

- **ログレベル**: INFO以上
- **ログ出力先**: Cloud Logging（自動）
- **ログ内容**:
  - メンション受信
  - 抽出されたデータ
  - スプレッドシート書き込み成功/失敗
  - Slack返信成功/失敗
  - エラー詳細

## 8. パフォーマンス考慮事項

- **Vertex AI**: `gemini-2.5-flash-lite` を使用（低レイテンシ・低コスト、Gemini 1.5は廃止済み）
- **Temperature**: 0に設定（一貫性のある結果）
- **JSONモード**: 強制してパース処理を簡素化
- **非同期処理**: 現在は同期処理だが、将来的に非同期化可能

## 9. 拡張性

### 9.1. 将来的な拡張案

- 複数スプレッドシート対応
- カスタムフィールドの追加
- バッチ処理対応
- エラーレトライ機能
- 通知機能の追加（メール、Chat等）

### 9.2. 設定の外部化

- プロンプトテンプレートの外部化
- バリデーションルールの設定化
- メッセージテンプレートの外部化
