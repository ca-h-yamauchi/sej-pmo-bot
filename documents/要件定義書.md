# Slack アカウント申請自動化システム 実装要件定義書

あなたはGoogle Cloud Platform (GCP) およびPython開発のエキスパートです。
以下の要件に基づき、Slackからのメンションを受け取り、Geminiで情報を抽出してGoogleスプレッドシートに転記する「サーバーレス・ボット」のPythonコード（Cloud Functions用）を作成してください。

## 1. システム概要
* **トリガー**: Slackでボットに対してメンションが飛んでくる（例：「@Bot 佐藤太郎さんのアカウント作成をお願い。営業部、sato@example.com」）。
* **処理**:
    1.  Slack Event APIからCloud Functionsがリクエストを受信。
    2.  Slack APIで送信者の表示名を取得し、問合せ者として記録。
    3.  受信したテキストと問合せ者名をVertex AI (Gemini 2.5 Flash Lite) に送り、構造化データ（JSON配列）として抽出。
    4.  抽出したデータ（複数件対応）をGoogleスプレッドシートの末尾に行として追加（1件ずつ行を分けて登録）。
    5.  Slackのスレッドに処理結果を返信。

## 2. 技術スタック
* **Runtime**: Python 3.11+
* **Platform**: Google Cloud Functions (第2世代 / HTTP Trigger)
* **AI Model**: Vertex AI `gemini-2.5-flash-lite` (低レイテンシ・低コストのため選択)
* **Libraries**:
    * `functions-framework`: Cloud Functionsのエントリーポイント用
    * `slack-sdk`: Slack API操作用
    * `google-cloud-aiplatform`: Vertex AI操作用
    * `gspread`: Google Sheets操作用 (および `google-auth`)

## 3. 詳細実装要件

### 3.1. エントリーポイントとセキュリティ (`main.py`)
* 関数名: `slack_bot_handler`
* **問合せ者の特定**:
    * `event['user']` からUser IDを取得し、`users.info` APIを使用してユーザー名（表示名、実名、またはUser ID）を取得して `inquirer_name` とする（`users:read`スコープが必要）。
    * AIのプロンプトに埋め込み、スプレッドシートの「問合せ者」列に記録する。
* **Slackリトライ対策 (重要)**:
    * HTTPヘッダー `X-Slack-Retry-Num` が存在する場合、処理を行わずに即座にHTTP 200を返して終了する（二重書き込み防止）。
* **署名検証**:
    * `SLACK_SIGNING_SECRET` を使用して、リクエストが正当なSlackからのものか検証する。
* **URL検証 (url_verification)**:
    * Slack APIの仕様に従い、`type` が `url_verification` の場合は `challenge` パラメータをそのまま返す処理を含める。

### 3.2. AI解析ロジック (Vertex AI)
* **モデル**: `gemini-2.5-flash-lite`
* **設定**:
    * Temperature: 0
    * Response Mime Type: `application/json` (JSONモードを強制)
* **プロンプト**:
    * **コンテキスト情報**: 問合せ者名（`inquirer_name`）をプロンプトに埋め込み、「私」や「自分」の言及があれば対象者を問合せ者名として扱う。
    * **出力形式**: JSONオブジェクトの**配列（List）**。1つのメッセージに複数の依頼がある場合は分割する。
    * **抽出する情報**:
        * **対象者情報**:
            * `target_name`: 対象者の氏名（「私」の場合は問合せ者名）
            * `target_email`: 対象者のメールアドレス (不明な場合は `null`)
        * **タグ情報**:
            * `tags`: 問い合わせの属性を表すタグの配列（最大5つ、不足する場合はnullで埋める）
            * タグの例：「アカウント管理」「アカウント新規申請登録」「スラック」「課題」「作業依頼」など
            * 1つの問い合わせに対して複数のタグを設定できる（例：アカウント管理の問い合わせには「アカウント管理」と「アカウント新規申請登録」のタグを両方設定）
            * **重要**: 問い合わせ内に所属を表す情報（例：「営業のAさん」「SREチームのBさん」「コンサルティング部のCさん」など）が明示的に含まれている場合は、その所属情報もタグに含めること。
              * 例：「営業のAさんのAsanaアカウント追加」→ `["アカウント管理", "新規登録", "Asana", "営業", null]`
              * 例：「SREチームのBさんのSlackアカウント作成」→ `["アカウント管理", "新規登録", "スラック", "SREチーム", null]`
        * **その他**:
            * `details`: 概要・詳細（不明な場合は `null`）
            * `due_date`: 対応期日（作業して欲しい期日が明示されている場合のみ記載。明示的な日付（例：「2024-01-31」）の場合はYYYY-MM-DD形式で返す。相対的な表現（例：「１月中」「来月末」「今週末」など）の場合は、そのままの表現で返すこと。不明な場合は `null`）
        * **オーダ情報**:
            * `order_number`: オーダ番号（990000～999999の数字のみの6桁、または数字2桁+JP+数字6桁の形式。該当しない場合は `null`）
            * `order_name`: オーダ名（オーダ番号の後に続くテキスト。オーダ番号がない場合は `null`）
* **バリデーション**:
    * **文字数チェック**: メッセージ本文が1000文字以内であることを確認（コスト削減のため）。1000文字を超える場合はエラーメッセージを返す。
    * AIのレスポンスをパースし、配列が空でないことを確認する。
    * タグに「アカウント管理」が含まれる場合のみ、`target_email`が必須。それ以外の場合は、メールアドレス、氏名は任意。
    * 必須項目が欠けている場合は、スプレッドシートへの書き込みをスキップし、ユーザーに適切なエラーメッセージを返す。
* **期日の正規化**:
    * Geminiから抽出された期日が相対的な表現（例：「１月中」「来月末」「今週末」など）の場合、`normalize_due_date()`関数で実際の日付（YYYY-MM-DD形式）に変換する。
    * 対応パターン：「○月中」「○月末」「今月末」「来月」「来週」「今週末」「○日後」など。
    * 全角・半角数字の両方に対応。

### 3.3. スプレッドシート連携
* 認証: ADC (Application Default Credentials) を使用（Cloud Functionsのサービスアカウント権限を利用）。
* 対象シート: 環境変数 `SPREADSHEET_KEY` で指定。
* 書き込み: 1行目にヘッダーがある前提で、抽出されたデータリストの各要素を最終行の下に追記する（複数件対応）。
* **カラム構成**:
    | 列 | 項目名 | 内容 |
    |:--|:--|:--|
    | A | **問合せNo** | 連番（自動採番） |
    | B | タイムスタンプ | `YYYY-MM-DD HH:MM:SS` |
    | C | **問合せ者** | `inquirer_name` (Slack User ID、例: `U1234567890`) |
    | D | **問合せ元Slack URL** | メッセージへのリンク（`https://{workspace}.slack.com/archives/{channel}/p{ts}`形式） |
    | E | **タグ1** | 問い合わせの属性を表すタグ（例：アカウント管理、スラック、課題など） |
    | F | **タグ2** | 問い合わせの属性を表すタグ（空欄可） |
    | G | **タグ3** | 問い合わせの属性を表すタグ（空欄可） |
    | H | **タグ4** | 問い合わせの属性を表すタグ（空欄可） |
    | I | **タグ5** | 問い合わせの属性を表すタグ（空欄可） |
    | J | **【対象】氏名** | `target_name` |
    | K | **【対象】Email** | `target_email` |
    | L | 対応期日 | `due_date` (YYYY-MM-DD形式、不明な場合は空欄) |
    | M | 概要・詳細 | `details` |
    | N | オーダ番号 | `order_number` (990000～999999の6桁、または数字2桁+JP+数字6桁形式、該当しない場合は空欄) |
    | O | オーダ名 | `order_name` (オーダ番号の後に続くテキスト、オーダ番号がない場合は空欄) |

### 3.4. Slackへのレスポンス
* 処理成功時: 「お問合せ頂いた内容について、以下の通りスプレッドシートに{件数}件登録しました。認識相違が無いかご確認ください。」と返信し、スプレッドシートの範囲リンク（問合せNoを含む）を表示。各件の対象者、メールアドレス、タグ、対応期日を表示。
* 文字数超過時: 「お問合せの内容が長すぎます（{文字数}文字）。1000文字以内で再度入力してください。」と返信。
* 抽出失敗時: 「情報を正しく読み取れませんでした。再度入力してください」と返信。
* バリデーションエラー時: タグに「アカウント管理」が含まれる場合でメールアドレスがない場合、「アカウント管理の依頼には対象者のメールアドレスが必要です。メールアドレスを含めて再度入力してください」と返信。

## 4. 必要なファイル構成
以下のファイルを作成してください。

1.  `main.py`: 上記ロジックを含むメインコード。
2.  `requirements.txt`: 必要なライブラリとバージョン。
3.  `.env.example`: 必要な環境変数の一覧（`SLACK_BOT_TOKEN`, `SLACK_SIGNING_SECRET`, `SPREADSHEET_KEY`, `PROJECT_ID`, `LOCATION`）。

## 5. コーディングの注意点
* 例外処理（Try-Except）を適切に入れ、エラー時はログ（Cloud Logging）に出力しつつ、Slackには「エラーが発生しました」と返すようにすること。
* コードは可読性を重視し、Type Hinting (型注釈) をつけること。
